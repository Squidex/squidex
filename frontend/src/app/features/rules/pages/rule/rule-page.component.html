<sqx-title [url]="['..']" message="i18n:rules.listPageTitle"></sqx-title>
<sqx-title message="i18n:rules.itemPageTitle"></sqx-title>

<form (ngSubmit)="save()">
    #
    <sqx-layout layout="main" innerWidth="54">
        <ng-container title>
            <div class="d-flex align-items-center">
                <a class="btn btn-text-secondary" (click)="back()" attr.aria-label="{{ 'common.back' | sqxTranslate }}">
                    <i class="icon-angle-left"></i>
                </a>

                <h3 class="title">{{ "common.rule" | sqxTranslate }}</h3>
            </div>
        </ng-container>

        <ng-container menu>
            @if (rule) {
                <div class="btn btn-outline-secondary btn-enabled ms-2">
                    @if (isEnabled) {
                        <span class="me-2">
                            {{ "common.enabled" | sqxTranslate }}
                        </span>
                    }
                    @if (!isEnabled) {
                        <span class="me-2">
                            {{ "common.disabled" | sqxTranslate }}
                        </span>
                    }
                    <sqx-toggle [(ngModel)]="isEnabled" [ngModelOptions]="{ standalone: true }" [disabled]="!isEditable"></sqx-toggle>
                </div>
            }

            @if (isManual) {
                <button
                    class="btn btn-outline-secondary btn-run ms-2"
                    [disabled]="!rule?.canTrigger"
                    (sqxConfirmClick)="trigger()"
                    confirmTitle="i18n:rules.triggerConfirmTitle"
                    confirmText="i18n:rules.triggerConfirmText"
                    confirmRememberKey="triggerRule">
                    <i class="icon-play-line"></i>
                </button>
            }

            <button class="btn btn-primary ms-2" (click)="save()" type="button">
                {{ "common.save" | sqxTranslate }}
            </button>
        </ng-container>

        <ng-container>
            @if (supportedActions && supportedTriggers) {
                <sqx-list-view innerWidth="54rem">
                    <div class="card mb-2">
                        <div class="card-header">
                            <div class="row align-items-center g-0 summary-row">
                                <div class="col-auto col-syntax">
                                    <h3>{{ "rules.ruleSyntax.if" | sqxTranslate }}</h3>
                                </div>
                                @if (currentTrigger) {
                                    <div class="col col-icon">
                                        <sqx-rule-element
                                            [type]="currentTrigger.triggerType"
                                            [element]="triggerElement"
                                            isSmall="true"
                                            disabled="true"></sqx-rule-element>
                                    </div>
                                }
                                @if (currentTrigger && !rule) {
                                    <div class="col text-end">
                                        <button class="btn btn-text-danger" (click)="resetTrigger()" type="button">
                                            <i class="icon-bin2"></i>
                                        </button>
                                    </div>
                                }
                                @if (!currentTrigger) {
                                    <div class="col">
                                        <h3>...</h3>
                                    </div>
                                }
                            </div>
                        </div>
                        <div class="card-body">
                            @if (currentTrigger) {
                                @if (!rule) {
                                    <sqx-form-alert marginTop="0">
                                        {{ "rules.triggerHint" | sqxTranslate }}
                                    </sqx-form-alert>
                                }
                                @switch (currentTrigger.triggerType) {
                                    @case ("AssetChanged") {
                                        <sqx-asset-changed-trigger [triggerForm]="currentTrigger"></sqx-asset-changed-trigger>
                                    }
                                    @case ("Comment") {
                                        <sqx-comment-trigger [triggerForm]="currentTrigger"></sqx-comment-trigger>
                                    }
                                    @case ("ContentChanged") {
                                        <sqx-content-changed-trigger
                                            [schemas]="schemasState.schemas | async"
                                            [trigger]="currentTrigger.form.value"
                                            [triggerForm]="currentTrigger"></sqx-content-changed-trigger>
                                    }
                                    @case ("SchemaChanged") {
                                        <sqx-schema-changed-trigger [triggerForm]="currentTrigger.form"></sqx-schema-changed-trigger>
                                    }
                                    @case ("Usage") {
                                        <sqx-usage-trigger [triggerForm]="currentTrigger"></sqx-usage-trigger>
                                    }
                                }
                            } @else {
                                <div class="row g-0">
                                    @for (triggerType of supportedTriggers | sqxKeys; track triggerType) {
                                        <div class="col-12 col-md-6">
                                            <div class="rule-element" (click)="selectTrigger(triggerType)">
                                                <sqx-rule-element
                                                    [type]="triggerType"
                                                    [element]="$any(supportedTriggers)[triggerType]"
                                                    isSmall="false"></sqx-rule-element>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="row align-items-center g-0 summary-row">
                                <div class="col-auto col-syntax">
                                    <h3>{{ "rules.ruleSyntax.then" | sqxTranslate }}</h3>
                                </div>
                                @if (currentAction) {
                                    <div class="col col-icon">
                                        <sqx-rule-element
                                            [type]="currentAction.actionType"
                                            [element]="$any(actionElement)"
                                            isSmall="true"
                                            disabled="true"></sqx-rule-element>
                                    </div>
                                }
                                @if (currentAction && !rule) {
                                    <div class="col text-end">
                                        <button class="btn btn-text-danger" (click)="resetAction()" type="button">
                                            <i class="icon-bin2"></i>
                                        </button>
                                    </div>
                                }
                                @if (!currentAction) {
                                    <div class="col">
                                        <h3>...</h3>
                                    </div>
                                }
                            </div>
                        </div>
                        <div class="card-body">
                            @if (currentAction) {
                                @if (!rule) {
                                    <sqx-form-alert marginTop="0">
                                        {{ "rules.actionHint" | sqxTranslate }}
                                    </sqx-form-alert>
                                }
                                <sqx-generic-action
                                    [actionForm]="currentAction"
                                    [trigger]="currentTrigger?.form.value"
                                    [triggerType]="currentTrigger?.triggerType"
                                    [appName]="rulesState.appName"></sqx-generic-action>
                            } @else {
                                <div class="row g-0">
                                    @for (actionType of supportedActions | sqxKeys; track actionType) {
                                        <div class="col-12 col-md-6">
                                            <div class="rule-element" (click)="selectAction(actionType)">
                                                <sqx-rule-element
                                                    [type]="actionType"
                                                    [element]="$any(supportedActions[actionType])"
                                                    isSmall="false"></sqx-rule-element>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                </sqx-list-view>
            }
        </ng-container>

        <ng-template sidebarMenu>
            <div class="panel-nav">
                @if (rule && (rulesState.canReadEvents | async)) {
                    <a
                        class="panel-link panel-link-gray"
                        [queryParams]="{ ruleId: rule.id }"
                        routerLink="events"
                        routerLinkActive="active"
                        title="i18n:common.history"
                        titlePosition="left"
                        sqxTourStep="history">
                        <i class="icon-time"></i>
                    </a>
                    <a
                        class="panel-link panel-link-gray"
                        [queryParams]="{ ruleId: rule.id }"
                        routerLink="simulator"
                        routerLinkActive="active"
                        title="i18n:rules.simulator"
                        titlePosition="left"
                        sqxTourStep="simulator">
                        <i class="icon-play-line"></i>
                    </a>
                }

                <a
                    class="panel-link"
                    #helpLink
                    replaceUrl="true"
                    routerLink="help"
                    routerLinkActive="active"
                    queryParamsHandling="preserve"
                    hintText="i18n:common.helpTour"
                    hintAfter="180000"
                    title="i18n:common.help"
                    titlePosition="left"
                    sqxTourStep="help">
                    <i class="icon-help2"></i>
                </a>
            </div>
        </ng-template>
    </sqx-layout>
</form>

<router-outlet></router-outlet>
