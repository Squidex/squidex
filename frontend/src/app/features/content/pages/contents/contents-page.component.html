<sqx-title [message]="schema.displayName"></sqx-title>

<sqx-layout layout="main" titleText="i18n:common.contents" titleIcon="contents">
    <ng-container menu>
        <div class="row flex-nowrap flex-grow-1 gx-2">
            <div class="col-auto ms-8">
                <sqx-notifo topic="apps/{{ contentsState.appId }}/schemas/{{ schema.id }}/contents" position="bottom-left"></sqx-notifo>

                <button
                    class="btn btn-text-secondary"
                    (click)="reload()"
                    type="button"
                    title="i18n:contents.refreshTooltip"
                    shortcut="CTRL + B">
                    <i class="icon-reset"></i>
                    {{ "common.refresh" | sqxTranslate }}
                </button>
            </div>
            <div class="col">
                <sqx-search-form
                    [language]="(languagesState.isoMasterLanguage | async)!"
                    [languages]="languages"
                    [queries]="queries | async"
                    [queriesTypes]="'common.contents' | sqxTranslate"
                    [query]="contentsState.query | async"
                    [queryModel]="queryModel | async"
                    [statuses]="contentsState.statuses | async"
                    (queryChange)="search($event)"
                    formClass="form"
                    placeholder="{{ 'contents.searchPlaceholder' | sqxTranslate }}"
                    enableShortcut="true"></sqx-search-form>
            </div>
            @if (languages.length > 1) {
                <div class="col-auto">
                    <sqx-language-selector
                        class="languages-buttons"
                        [language]="language"
                        [languages]="languages"
                        [percents]="translationStatus"
                        (languageChange)="changeLanguage($event)"></sqx-language-selector>
                </div>
            }
            <div class="col-auto">
                <button
                    class="btn btn-success"
                    [disabled]="(contentsState.canCreateAny | async) === false"
                    type="button"
                    routerLink="new"
                    title="i18n:contents.createContentTooltip"
                    shortcut="CTRL + U"
                    sqxTourStep="addContent">
                    <i class="icon-plus"></i>
                    {{ "contents.create" | sqxTranslate }}
                </button>
            </div>
        </div>
    </ng-container>

    <ng-container>
        @if (tableSettings | async; as tableSettings) {
            @if (tableSettings.listFields | async; as tableFields) {
                <sqx-list-view [isLoading]="contentsState.isLoading | async" syncedHeader="true" tableNoPadding="true">
                    <ng-container topHeader>
                        @if (selectionCount > 0) {
                            <div class="selection">
                                {{ "contents.selectionCount" | sqxTranslate: { count: selectionCount } }}&nbsp;&nbsp;
                                @for (status of selectionStatuses | sqxKeys; track status) {
                                    <button
                                        class="btn btn-outline-secondary btn-status me-2"
                                        (click)="changeSelectedStatus(status)"
                                        type="button">
                                        <sqx-content-status
                                            [status]="status"
                                            [statusColor]="selectionStatuses[status]"
                                            layout="text"></sqx-content-status>
                                    </button>
                                }
                                @if (selectionCanDelete) {
                                    <button
                                        class="btn btn-danger"
                                        (sqxConfirmClick)="deleteSelected()"
                                        type="button"
                                        confirmTitle="i18n:contents.deleteConfirmTitle"
                                        confirmText="i18n:contents.deleteManyConfirmText"
                                        confirmRememberKey="deleteContents">
                                        {{ "common.delete" | sqxTranslate }}
                                    </button>
                                }
                            </div>
                        }
                        <div class="settings-container">
                            <button class="btn btn-sm settings-button" #buttonSettings (click)="tableViewModal.toggle()" type="button">
                                <span class="hidden">{{ "common.settings" | sqxTranslate }}</span>
                                <i class="icon-settings"></i>
                            </button>
                            <sqx-dropdown-menu
                                *sqxModal="tableViewModal"
                                [sqxAnchoredTo]="buttonSettings"
                                scrollY="true"
                                position="bottom-end">
                                <sqx-custom-view-editor
                                    [allFields]="tableSettings.schemaFields"
                                    [listFields]="$any(tableFields)"
                                    (listFieldsChange)="tableSettings.updateFields($event)"
                                    (listFieldsReset)="tableSettings.reset()"></sqx-custom-view-editor>
                            </sqx-dropdown-menu>
                        </div>
                    </ng-container>
                    <ng-container header>
                        <table class="table table-items table-fixed" #header [sqxContentListWidth]="tableFields" [fields]="tableSettings">
                            <thead>
                                <tr>
                                    <th class="cell-select">
                                        <div class="form-check">
                                            <input
                                                class="form-check-input"
                                                id="all_selected"
                                                [ngModel]="selectedAll"
                                                (ngModelChange)="selectAll($event)"
                                                type="checkbox" />
                                            <label class="form-check-label" for="all_selected"></label>
                                        </div>
                                    </th>
                                    <th class="cell-actions cell-actions-left">
                                        <span class="truncate">{{ "common.actions" | sqxTranslate }}</span>
                                    </th>
                                    @for (field of tableFields; track field) {
                                        <th [field]="field" [fields]="tableSettings" sqxContentListCell sqxContentListCellResize>
                                            <sqx-content-list-header
                                                [field]="field"
                                                [query]="(contentsState.query | async)!"
                                                [language]="language"
                                                (queryChange)="search($event)"></sqx-content-list-header>
                                        </th>
                                    }
                                    <th></th>
                                </tr>
                            </thead>
                        </table>
                    </ng-container>
                    <ng-container>
                        <div class="table-container">
                            <table
                                class="table table-center table-fixed"
                                [sqxContentListWidth]="tableFields"
                                [fields]="tableSettings"
                                [sqxSyncWidth]="header">
                                @for (content of contentsState.contents | async; track content.id) {
                                    <tbody
                                        [sqxContent]="content"
                                        [cloneable]="contentsState.snapshot.canCreate"
                                        [language]="language"
                                        [languages]="languages"
                                        [link]="[content.id, 'history']"
                                        [schema]="schema"
                                        [selected]="isItemSelected(content)"
                                        [tableFields]="tableFields"
                                        [tableSettings]="tableSettings"
                                        (clone)="clone(content)"
                                        (delete)="delete(content)"
                                        (selectedChange)="selectItem(content, $event)"
                                        (statusChange)="changeStatus(content, $event)"></tbody>
                                }
                            </table>
                        </div>
                    </ng-container>
                    <ng-container footer>
                        <sqx-pager
                            [paging]="contentsState.paging | async"
                            (loadTotal)="reloadTotal()"
                            (pagingChange)="contentsState.page($event)"></sqx-pager>
                    </ng-container>
                </sqx-list-view>
            }
        }
    </ng-container>

    <ng-template sidebarMenu>
        <div class="panel-nav">
            <a
                class="panel-link"
                replaceUrl="true"
                routerLink="filters"
                routerLinkActive="active"
                queryParamsHandling="preserve"
                title="i18n:common.filters"
                titlePosition="left"
                sqxTourStep="filters">
                <i class="icon-filter"></i>
            </a>

            @if (schema.properties.contentsSidebarUrl) {
                <a
                    class="panel-link"
                    replaceUrl="true"
                    routerLink="sidebar"
                    routerLinkActive="active"
                    queryParamsHandling="preserve"
                    title="i18n:common.sidebar"
                    titlePosition="left"
                    sqxTourStep="plugin">
                    <i class="icon-plugin"></i>
                </a>
            }
        </div>
    </ng-template>
</sqx-layout>

<router-outlet></router-outlet>

<sqx-due-time-selector #dueTimeSelector [disabled]="disableScheduler"></sqx-due-time-selector>
