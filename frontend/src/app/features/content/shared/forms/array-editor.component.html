@if (formModel.itemChanges | async; as items) {
    @if (items.length > 0 && items.length <= 20) {
        <div
            class="array-container static"
            [class.expanded]="isExpanded"
            [cdkDropListSortingDisabled]="isDisabled | async"
            [cdkDropListDisabled]="isDisabled | async"
            [cdkDropListData]="items"
            (cdkDropListDropped)="sort($event)"
            cdkDropList>
            @for (itemForm of items; track itemForm; let i = $index; let isLast = $last; let isFirst = $first) {
                <div class="table-drag item" [class.first]="isFirst" [class.last]="isLast" cdkDrag cdkDragLockAxis="y">
                    <sqx-array-item
                        [form]="form"
                        [formContext]="formContext"
                        [formLevel]="formLevel + 1"
                        [formModel]="itemForm"
                        [index]="i"
                        [isComparing]="isComparing"
                        [isCollapsedInitial]="isCollapsedInitial"
                        [isDisabled]="isDisabled | async"
                        [isFirst]="isFirst"
                        [isLast]="isLast"
                        [hasChatBot]="hasChatBot"
                        [language]="language"
                        [languages]="languages"
                        (clone)="addCopy(itemForm)"
                        (itemRemove)="removeItem(i)"
                        (itemMove)="move(itemForm, $event)">
                        <i class="icon-drag2" [class.disabled]="isDisabled | async" cdkDragHandle></i>
                    </sqx-array-item>
                </div>
            }
        </div>
    }
    @if (items.length > 20) {
        <div class="array-container" [class.expanded]="isExpanded">
            <virtual-scroller #scroll [items]="$any(items)" [enableUnequalChildrenSizes]="true">
                @for (itemForm of scroll.viewPortItems; track itemForm; let i = $index) {
                    <div
                        class="item"
                        [class.first]="scroll.viewPortInfo.startIndexWithBuffer + i === 0"
                        [class.last]="scroll.viewPortInfo.startIndexWithBuffer + i === items.length - 1">
                        <sqx-array-item
                            [form]="form"
                            [formContext]="formContext"
                            [formLevel]="formLevel + 1"
                            [formModel]="itemForm"
                            [index]="scroll.viewPortInfo.startIndexWithBuffer + i"
                            [isCollapsedInitial]="isCollapsedInitial"
                            [isComparing]="isComparing"
                            [isDisabled]="isDisabled | async"
                            [isFirst]="scroll.viewPortInfo.startIndexWithBuffer + i === 0"
                            [isLast]="scroll.viewPortInfo.startIndexWithBuffer + i === items.length - 1"
                            [hasChatBot]="hasChatBot"
                            [language]="language"
                            [languages]="languages"
                            (clone)="addCopy(itemForm)"
                            (itemExpanded)="scroll.invalidateCachedMeasurementAtIndex(scroll.viewPortInfo.startIndexWithBuffer + i)"
                            (itemRemove)="removeItem(scroll.viewPortInfo.startIndexWithBuffer + i)"
                            (itemMove)="move(itemForm, $event)"></sqx-array-item>
                    </div>
                }
            </virtual-scroller>
        </div>
    }
    <div class="array-buttons row g-0 align-items-center" [class.expanded]="isExpanded">
        <div class="col-auto">
            @if (isArray) {
                @if (hasField) {
                    <button class="btn btn-outline-success" [disabled]="isDisabledOrFull | async" (click)="addItem()" type="button">
                        {{ "contents.arrayAddItem" | sqxTranslate }}
                    </button>
                }
                @if (!hasField) {
                    <sqx-form-hint>
                        {{ "contents.arrayNoFields" | sqxTranslate }}
                    </sqx-form-hint>
                }
            } @else {
                @if (schemasList.length > 1) {
                    <button
                        class="btn btn-outline-success dropdown-toggle"
                        #buttonSelect
                        [disabled]="isDisabledOrFull | async"
                        (click)="schemasDropdown.show()"
                        type="button">
                        {{ "contents.addComponent" | sqxTranslate }}
                    </button>
                    <sqx-dropdown-menu *sqxModal="schemasDropdown; closeAlways: true" [sqxAnchoredTo]="buttonSelect" scrollY="true">
                        @for (schema of schemasList; track schema) {
                            <a class="dropdown-item" (click)="addComponent(schema)">
                                {{ schema.displayName }}
                            </a>
                        }
                    </sqx-dropdown-menu>
                }
                @if (schemasList.length === 1) {
                    <button
                        class="btn btn-outline-success"
                        [disabled]="isDisabledOrFull | async"
                        (click)="addComponent(schemasList[0])"
                        type="button">
                        {{ "contents.addComponent" | sqxTranslate }}
                    </button>
                }
                @if (schemasList.length === 0) {
                    <sqx-form-hint>
                        {{ "contents.componentsNoSchema" | sqxTranslate }}
                    </sqx-form-hint>
                }
            }
        </div>
        <div class="col">
            @if (items.length > 0) {
                <button
                    class="btn btn-text-danger ms-2"
                    [disabled]="isDisabled | async"
                    (sqxConfirmClick)="clear()"
                    type="button"
                    confirmTitle="i18n:contents.arrayClearConfirmTitle"
                    confirmText="i18n:contents.arrayClearConfirmText"
                    confirmRememberKey="leaveApp">
                    {{ "contents.arrayClear" | sqxTranslate }}
                </button>
            }
        </div>
        @if (items.length > 0) {
            <div class="col-auto">
                <button class="btn btn-text-secondary" (click)="expandAll()" type="button" title="i18n:contents.arrayExpandAll">
                    <i class="icon-plus-square"></i>
                </button>
                <button class="btn btn-text-secondary" (click)="collapseAll()" type="button" title="i18n:contents.arrayCollapseAll">
                    <i class="icon-minus-square"></i>
                </button>
            </div>
        }
    </div>
}
